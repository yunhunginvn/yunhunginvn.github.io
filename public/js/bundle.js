!function(e){var t={};function s(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:i})},s.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";function i(e,t="",s="",i={}){let r=document.createElement(e);for(var a in""!==s&&(r.innerHTML=s),""!==t&&(r.classList+=t),i)r.setAttribute(a,i[a]);return n(r)}s.r(t);const n=function(e){return e.hide=(()=>{e.classList+=" hide"}),e.show=(()=>{e.classList.remove("hide")}),e.addClass=(t=>{e.classList+=` ${t}`}),e.removeClass=(t=>{e.classList.remove(t)}),e},r={LEFT:Symbol("left"),RIGHT:Symbol("right")},a={MESSAGE:Symbol("message"),SELECTION:Symbol("selection")};function o(e,t){return{text:e,callback:t}}class h{constructor(){this.dialogs=[],this.dialogDisplayer=document.getElementById("content-body"),this.msgCount=0}createReceiveMessageFunc(){let e=this;return function(t){e.addDialog(t,a.MESSAGE,{speaker:r.RIGHT})}}addLoadingDialog(e){return this.addDialog("",a.MESSAGE,{loadingTime:e})}addDialog(e,t=a.MESSAGE,s={}){let i={type:t,message:e,speaker:r.LEFT};return i=Object.assign({},i,s),this.dialogs.push(i),this.renderDialog(i),this.msgCount-1}updateDialog(e,t={}){return"number"!=typeof e||this.dialogs.length<=e?null:(this.dialogs[e]=Object.assign({},this.dialogs[e],t),document.getElementById(`msg-${e}`).innerHTML=this.dialogs[e].message,!0)}renderDialog(e){e.type===a.MESSAGE?this.renderMessage(e):e.type===a.SELECTION&&this.renderSelection(e)}renderSelection(e){let t=i("div","dialog"),s=i("div","selection");e.message.forEach(e=>{let t=i("button","",e.text);t.addEventListener("click",t=>e.callback(t)),s.appendChild(t)}),t.appendChild(s),this.dialogDisplayer.appendChild(t),this.scrollToBottom()}renderMessage(e){let t=e.speaker===r.LEFT?"side-left":"side-right",s=e.speaker===r.LEFT?"monkey-portrait":"vietnam-portrait",n=i("div",`dialog ${t}`),a=i("span"),o=i("img","chat-portrait","",{src:`public/img/${s}.png`}),h=i("div","message"),l=i("span");l.id=`msg-${this.msgCount}`,l.innerHTML=e.message,this.msgCount++,e.loadingTime&&(setTimeout(()=>{h.show(),a.hide()},e.loadingTime),h.addClass("hide"),a.addClass("loading")),h.appendChild(l),e.speaker===r.LEFT?(n.appendChild(o),n.appendChild(h),n.appendChild(a)):(n.appendChild(a),n.appendChild(h),n.appendChild(o)),this.dialogDisplayer.appendChild(n),this.scrollToBottom()}renderDialogs(){this.dialogs.forEach(e=>{this.renderDialog(e)})}scrollToBottom(){this.dialogDisplayer.scrollTo(0,this.dialogDisplayer.scrollHeight)}}class l{constructor(e,t){this.displayer=e,this.game=t}createReceiveMessageFunc(){let e=this;return function(t){let s=e.displayer.addLoadingDialog(1500);setTimeout(()=>e.responseDefaultReply(s),1500)}}responseMessage(e,t=null){return this.displayer.addDialog(e,a.MESSAGE,{loadingTime:t})}responseSelections(e){return this.displayer.addDialog(e,a.SELECTION)}responseDefaultSelection(){let e=[o("Profile",()=>{this.responseMessage("Yun Hung is a software engineer, experienced in web development and game development."),this.responseSelections([o("Web experience",()=>this.responseMessage("Yun Hung had experience to develop streaming service and ERP system, and he was responsible for developing application server, built on AWS platform.")),o("Game experience",()=>{this.responseMessage("Yun Hung had two years experience to develop a MMORPG with a team."),this.responseMessage('<a href="https://www.youtube.com/watch?v=kueS1sQooYk" target="_blank">Game introduction</a>')}),o("Nationality",()=>this.responseMessage("My creator is from Taiwan. ðŸ‡¹ðŸ‡¼"))])}),o("Play a Game",()=>{this.game.flyin()}),o("Contact",()=>this.responseMessage('<a href="mailto:yunhunginvn@gmail.com">yunhunginvn@gmail.com</a>'))];this.responseSelections(e)}responseOpening(){this.responseMessage("Hello! I am a chatbot for introducing my creator : Yun Hung."),this.responseMessage("Let me know which area you are interested in."),this.responseDefaultSelection()}responseDefaultReply(e){this.displayer.updateDialog(e,{message:"Let me know which area you are interested in."}),this.responseDefaultSelection()}start(){this.responseOpening()}}class d{constructor(){this.textInputCount=0,this.textInput=new Map,this.mouseInput=new Map}initListener(){this.textInput.forEach((e,t)=>{function s(){""!==e.textDom.value&&(e.callbacks.forEach(t=>{t(e.textDom.value)}),e.textDom.value="")}e.triggerClickedDom.addEventListener("click",e=>s()),e.triggerByEnter&&window.addEventListener("keydown",e=>{"Enter"==e.code&&s()})}),this.mouseInput.forEach((e,t)=>{t.addEventListener("mousemove",t=>{let{offsetX:s,offsetY:i}=t;e.mousemoveCallbacks.forEach(e=>e(s,i))}),t.addEventListener("click",t=>{let{offsetX:s,offsetY:i}=t;e.mouseclickCallbacks.forEach(e=>e(s,i))})})}addTextInput(e,t,s=!0){let i=this.textInputCount;return this.textInputCount++,this.textInput.set(i,{textDom:e,triggerClickedDom:t,triggerByEnter:s,callbacks:[]}),i}registerTextInputEvent(e,t){let s=this.textInput.get(e);if(!s)return null;s.callbacks.push(t),this.textInput.set(e,s)}registerMouseEvent(e,t,s){let i=this.mouseInput.get(e);i||(i={mousemoveCallbacks:[],mouseclickCallbacks:[]}),"mousemove"===t&&i.mousemoveCallbacks.push(s),"click"===t&&i.mouseclickCallbacks.push(s),this.mouseInput.set(e,i)}}class c{constructor(e=1/60){let t=null,s=0;this.proxyUpdate=(i=>{null===t&&(t=i);let n=(i-t)/1e3;t=i,(s+=n)>=e&&(this.update(n),s=0),this.enqueue()})}update(e){throw new Error("have to override update method!")}enqueue(){requestAnimationFrame(this.proxyUpdate)}start(){this.enqueue()}}class u{constructor(e=0,t=0){this.set(e,t)}set(e,t){this.x=e,this.y=t}equal(e){return this.x===e.x&&this.y===e.y}}function p(e){return e/Math.PI*180}function m(e,t){let s=function(e,t){var s=t.x-e.x,i=t.y-e.y;return 360*Math.atan(i/s)/(2*Math.PI)}(e,t);return s>=0&&s<=90&&e.x>=t.x&&(s+=180),s<0&&(s+=360)>=270&&s<=360&&e.x>t.x&&(s+=180),s}function g(e,t){let s=e.x-t.x,i=e.y-t.y;return Math.sqrt(s*s+i*i)}const y=new u(.5,.5),f=new u(32,32);class w{constructor(e){this.image=e,this.sprites=new Map}define(e,t,s,i,n){let r=document.createElement("canvas");r.width=i,r.height=n;let a=r.getContext("2d");a.scale(y.x,y.y),a.drawImage(this.image,t,s,i,n,0,0,i,n),this.sprites.set(e,r)}buffer(e,t){let s=document.createElement("canvas");return s.width=e,s.height=t,s}drawToBuffer(e,t,s,i,n,r=0,a=0,o=!1){let h=e.getContext("2d");return h.save(),o?(h.scale(y.x,-y.y),h.translate(0,-n)):h.scale(y.x,y.y),h.drawImage(this.image,t,s,i,n,r,a,i,n),h.restore(),e}defineBuffer(e,t){this.sprites.set(e,t)}render(e,t,s,i,n=0){let r=this.sprites.get(t);r&&(0!==n?(e.save(),e.translate(s+f.x/2,i+f.y/2),e.rotate(n*Math.PI/180),e.drawImage(r,-r.width/2*y.x,-r.height/2*y.y),e.restore()):e.drawImage(r,s,i))}}function x(e){return fetch(e).then(e=>e.json())}function v(e){return x(e).then(e=>Promise.all([e,(t=e.imageURL,new Promise(e=>{let s=new Image;s.onload=(()=>e(s)),s.src=t}))])).then(([e,t])=>{let s=new w(t);if(e.frames){let t,i,n;e.frames.forEach(e=>{"282"==e.name&&(t=e),"296"==e.name&&(i=e),"298"==e.name&&(n=e),s.define(e.name,...e.rect)});let r=s.buffer(t.rect[2],t.rect[3]);r=s.drawToBuffer(r,i.rect[0],i.rect[1],i.rect[2],i.rect[3],0,-32,!0),r=s.drawToBuffer(r,...t.rect),s.defineBuffer("299",r),r=s.buffer(64,128),r=s.drawToBuffer(r,n.rect[0],n.rect[1],n.rect[2],n.rect[3],0,-16),s.defineBuffer("300",r),r=s.buffer(64,128),r=s.drawToBuffer(r,n.rect[0],n.rect[1],n.rect[2],n.rect[3],8,-16),r=s.drawToBuffer(r,n.rect[0],n.rect[1],n.rect[2],n.rect[3],-8,-16),s.defineBuffer("301",r)}return s});var t}const b=new u(32,32);class M{constructor(){this.layers=new Map}addLayer(e,t){this.layers.set(e,t)}render(e,t){this.layers.forEach(s=>{s.forEach((s,i)=>{s.forEach((s,n)=>{t.render(e,s,i*b.x,n*b.y)})})})}}function E(e){switch(e){case"$":return"191";case"*":return"202";default:return`18${e}`}}class T{constructor(e,t=0,s=0,i={}){this.spriteName=e,this.offset=new u(t,s),this.attributes=i}}class S{constructor(e,t,s,i){this.pos=new u(e,t),this.size=new u(s,i),this.face=90,this.components=[],this.traits=[]}missionCompleted(){this.gainPunishment(),this.selfRemove()}missionFailed(){this.gainReward(),this.selfRemove()}setId(e){return this.id=e,this}setContainer(e){return this.container=e,this}selfRemove(){this.container&&this.container.removeEntity(this.id)}gainReward(){this.container&&this.container.gainReward(this.id)}gainPunishment(){this.container&&this.container.gainPunishment(this.id)}get center(){return new u(this.centerX,this.centerY)}get centerX(){return this.pos.x+this.size.x/2}get centerY(){return this.pos.y+this.size.y/2}get renderPos(){return new u(this.renderPosX,this.renderPosY)}get renderPosX(){return this.pos.x-this.size.x/2}get renderPosY(){return this.pos.y-this.size.y/2}addTrait(e){this.traits.push(e),this[e.NAME]=e}updateTraits(e){this.traits.forEach(t=>{t.update(e)})}emptyComponent(){this.components=[]}appendComponent(e){e instanceof T&&this.components.push(e)}appendComponentTo(e,t){t.forEach(t=>{e.appendComponent(new T(...t))})}render(e,t){this.components.forEach(s=>{t.render(e,s.spriteName,this.renderPosX+s.offset.x,this.renderPosY+s.offset.y,this.face)}),this.traits.forEach(s=>{s.render(e,t)})}}class C{constructor(e){this.NAME=e}update(e){}render(e,t){}}class I extends C{constructor(e){super("clickable"),this.entity=e}onClick(e,t){if(e>=this.entity.pos.x&&e<=this.entity.pos.x+this.entity.size.x&&t>=this.entity.pos.y&&t<=this.entity.pos.y+this.entity.size.y)return this.entity.onClick()}}class F extends S{constructor(e=0,t=0,s=3*b.x,i=b.y){super(e,t,s,i),this.addTrait(new I(this)),this._face=270}get renderPosX(){return this.pos.x}get renderPosY(){return this.pos.y}set face(e){this._face=e}get face(){return this._face+90}onClick(){if(window.gameRef.dashboard.towerMenu.isShow&&window.gameRef.gameState.coin>=this.price){window.gameRef.gameState.coin-=this.price;let e=window.gameRef.dashboard.towerMenu.selectedTower;e.emptyComponent(),e.equip.setEquipment(this.equiptment),this.appendComponentTo(e,this.tiles),window.gameRef.dashboard.towerMenu.enable(!1)}}appendComponentTo(e,t){t.forEach(t=>{e.appendComponent(new T(...t)),t[3]&&"fire"==t[3].name&&(e.fireSprite.spriteName=t[0])})}appendPrice(e){this.price=e;let t=("xx"+this.price.toString()).slice(-3),s=1;for(var i in t)"x"!=t[i]&&this.appendComponent(new T(E(t[i]),b.x*s,0)),s+=.5}}class k extends F{constructor(e=0,t=0,s=3*b.x,i=b.y){super(e,t,s,i),this.tiles=[["256",0,0,{rotatable:!1}],["280",0,0],["301",0,0,{name:"fire",show:!1}]],this.equiptment={damage:10,fireSpeed:.5,range:100,weapon:"double-gun"},this.appendComponentTo(this,this.tiles.slice(0,-1)),this.appendPrice(100)}}class N extends F{constructor(e=0,t=0,s=3*b.x,i=b.y){super(e,t,s,i),this.tiles=[["256",0,0,{rotatable:!1}],["279",0,0],["300",0,0,{name:"fire",show:!1}]],this.equiptment={damage:4,fireSpeed:.3,range:120,weapon:"single-gun"},this.appendComponentTo(this,this.tiles.slice(0,-1)),this.appendPrice(50)}}class P extends F{constructor(e=0,t=0,s=3*b.x,i=b.y){super(e,t,s,i),this.tiles=[["256",0,0,{rotatable:!1}],["266",0,0],["274",0,0]],this.equiptment={damage:20,fireSpeed:1.7,range:150,weapon:"rocket"},this.appendComponentTo(this,this.tiles),this.appendPrice(200)}}const R=3*b.x,A=3*b.y;class G{constructor(){this.isShow=!1,this.selectedTower=null,this.background=[new u(3,8),new u(4,8),new u(5,8),new u(3,9),new u(4,9),new u(5,9),new u(3,10),new u(4,10),new u(5,10)],this.items=[new N(3*b.x,8*b.y).setId(0),new k(3*b.x,9*b.y).setId(1),new P(3*b.x,10*b.y).setId(2)]}init(){this.isShow=!1}enable(e=!0){e?this.isShow=e:setTimeout(()=>{this.isShow=e,this.selectedTower=null},0)}towerSelected(e){this.selectedTower=e}isInsieBackgound(e,t){let s=this.background[0];return e>=s.x*b.x&&e<=s.x*b.x+R&&t>=s.y*b.y&&t<=s.y*b.y+A}onMouseclick(e,t){this.isShow&&(this.isInsieBackgound(e,t)?this.items.forEach(s=>{s.clickable.onClick(e,t)}):this.enable(!1))}render(e,t){this.isShow&&(this.background.forEach(s=>{t.render(e,"046",s.x*b.x,s.y*b.y)}),this.items.forEach(s=>{s.render(e,t)}))}}class L{constructor(e){this.canvas=e,this.towerMenu=new G}init(e){this.gameState=e,this.towerMenu.init()}onMouseclick(e,t){this.towerMenu.onMouseclick(e,t)}renderLife(e,t){let s=this.canvas.width*t;e.fillStyle="#910404",e.fillRect(0,this.canvas.height-3,s,3)}renderCoin(e,t,s){let i=s.toString(),n=1.5*b.x;t.render(e,E("$"),n,0);for(var r=0;r<i.length;r++)t.render(e,E(i[r]),16*(r+1)+n,0)}renderWave(e,t,s){let i=s.toString(),n=6.5*b.x;n-=8*(i.length-1),t.render(e,E("*"),n,0);for(var r=0;r<i.length;r++)t.render(e,E(i[r]),16*(r+1)+n,0)}render(e,t){e.fillStyle="#2ECC71",e.fillRect(0,0,this.canvas.width,b.y),this.renderCoin(e,t,this.gameState.coin),this.renderLife(e,this.gameState.life/this.gameState.maxLife),this.renderWave(e,t,window.gameRef.level.entityMgr.currWaveId+1),this.towerMenu.render(e,t)}}class O extends C{constructor(e,t=1){super("heartbeat"),this.accumulatedTime=0,this.entity=e,this.beatTime=t}update(e){this.accumulatedTime+=e,this.accumulatedTime>=this.beatTime&&(this.entity.onHeartbeat(),this.accumulatedTime=0)}}class D extends C{constructor(e){super("move"),this.entity=e,this.vel=new u(0,0),this.speed=10,this.path=[],this.prevNodeIterator=null,this.nextNodeIterator=null,this.executingRunCircle=!1}get prevNode(){return null===this.prevNodeIterator?null:this.path[this.prevNodeIterator]}get nextNode(){return null===this.nextNodeIterator?null:this.path[this.nextNodeIterator]}targetToNextNode(){this.nextNodeIterator+1>=this.path.length?this.nextNodeIterator=null:(this.prevNodeIterator=this.nextNodeIterator,this.nextNodeIterator++)}setPath(e){this.path=e,this.nextNodeIterator=0}update(e){if(null!==this.nextNode&&"begin"===this.nextNode.type&&(this.entity.pos.x=this.nextNode.dest.x,this.entity.pos.y=this.nextNode.dest.y,this.targetToNextNode()),null!==this.nextNode&&"line"===this.nextNode.type){let t=this.speed*e,s=this.speed*e;Math.abs(this.nextNode.dest.x-this.entity.pos.x)>=t&&(this.entity.pos.x+=this.nextNode.dest.x-this.entity.pos.x>0?t:-t),Math.abs(this.nextNode.dest.y-this.entity.pos.y)>=s&&(this.entity.pos.y+=s),Math.abs(this.nextNode.dest.x-this.entity.pos.x)<t&&Math.abs(this.nextNode.dest.y-this.entity.pos.y)<s&&(this.entity.pos.x=this.nextNode.dest.x,this.entity.pos.y=this.nextNode.dest.y,this.targetToNextNode())}if(null!==this.nextNode&&"circle"===this.nextNode.type){if(this.executingRunCircle)return;let e=function(t,s,i,n,r,a){let o=s.face,h=Object.assign({},s.pos),l=g(i,h),d=t.speed/10,c=0,u=r?1:-1;return function(){if(!1===t.executingRunCircle)return;let i,r,m,g,y=1/120*c*d*3*180*Math.PI;1==a?(i=l*Math.cos(y),r=l*Math.sin(y),m=l-Math.abs(i),g=Math.abs(r),m<=l&&(s.pos.x=h.x-m),g<=l&&(s.pos.y=h.y+g)):2==a?(i=l*Math.cos(y),r=l*Math.sin(y),m=l-Math.abs(i),g=Math.abs(r),m<=l&&(s.pos.x=h.x+m),g<=l&&(s.pos.y=h.y+g)):3==a?(i=l*Math.sin(y),r=l*Math.cos(y),m=Math.abs(i),g=l-Math.abs(r),m<=l&&(s.pos.x=h.x-m),g<=l&&(s.pos.y=h.y+g)):4==a&&(i=l*Math.sin(y),r=l*Math.cos(y),m=Math.abs(i),g=l-Math.abs(r),m<=l&&(s.pos.x=h.x+m),g<=l&&(s.pos.y=h.y+g)),s.face=o+p(y)*u,p(y)>=90?(s.pos.x=n.x,s.pos.y=n.y,s.face=o+90*u,t.executingRunCircle=!1,t.targetToNextNode()):setTimeout(e,1/120*1e3),c+=1/120}}(this,this.entity,this.nextNode.orig,this.nextNode.dest,this.nextNode.cloc,this.nextNode.radi);this.executingRunCircle=!0,e()}null===this.nextNode&&this.entity.missionCompleted()}displace(e,t){return 0==e?0:e>0?e>t?t:e:e<0?Math.abs(e)>t?e>0?t:-t:e:void 0}hearbeat(){}}class W extends C{constructor(e,t=1){super("life"),this.entity=e,this.setHp(t)}get hpColor(){let e=this.hpRate;return e>.66?"#01871c":e>.33?"#baa103":"#91190b"}get hpRate(){return this.hp/this.maxHp}get isAlive(){return this.hp>0}get isFullHp(){return this.hp==this.maxHp}setHp(e){this.hp=e,this.maxHp=e}damage(e){this.isAlive&&(this.hp-=e,this.hp<=0&&(this.hp=0,this.executeDeadProcess()))}executeDeadProcess(){this.entity.missionFailed()}render(e,t){this.isFullHp||(e.fillStyle=this.hpColor,e.fillRect(this.entity.renderPosX,this.entity.renderPosY-3,this.entity.size.x*this.hpRate,2))}}class H extends S{constructor(e=0,t=0,s=b.x,i=b.y){super(e,t,s,i),this.addTrait(new O(this,1/60)),this.addTrait(new D(this)),this.addTrait(new W(this)),this.move.speed=60,this.reward={coin:5}}onHeartbeat(){}update(e){this.updateTraits(e)}}const q=[()=>new class extends H{constructor(e=0,t=0,s=b.x,i=b.y){super(e,t,s,i),this.tiles=[["275",0,0]],this.appendComponentTo(this,this.tiles),this.move.speed=20,this.life.setHp(20),this.reward.coin=5}onHeartbeat(){}update(e){this.updateTraits(e)}},()=>new class extends H{constructor(e=0,t=0,s=b.x,i=b.y){super(e,t,s,i),this.tiles=[["276",0,0]],this.appendComponentTo(this,this.tiles),this.move.speed=25,this.life.setHp(15),this.reward.coin=7}onHeartbeat(){}update(e){this.updateTraits(e)}},()=>new class extends H{constructor(e=0,t=0,s=b.x,i=b.y){super(e,t,s,i),this.tiles=[["283",0,0],["291",0,0]],this.appendComponentTo(this,this.tiles),this.move.speed=20,this.life.setHp(150),this.reward.coin=15}onHeartbeat(){}update(e){this.updateTraits(e)}},()=>new class extends H{constructor(e=0,t=0,s=b.x,i=b.y){super(e,t,s,i),this.tiles=[["284",0,0],["292",0,0]],this.appendComponentTo(this,this.tiles),this.move.speed=15,this.life.setHp(300),this.reward.coin=20}onHeartbeat(){}update(e){this.updateTraits(e)}},()=>new class extends H{constructor(e=0,t=0,s=b.x,i=b.y){super(e,t,s,i),this.tiles=[["293",-4,8],["285",0,0]],this.appendComponentTo(this,this.tiles),this.move.speed=60,this.life.setHp(70),this.reward.coin=15}onHeartbeat(){}update(e){this.updateTraits(e)}},()=>new class extends H{constructor(e=0,t=0,s=b.x,i=b.y){super(e,t,s,i),this.tiles=[["294",-4,8],["286",0,0]],this.appendComponentTo(this,this.tiles),this.move.speed=40,this.life.setHp(100),this.reward.coin=10}onHeartbeat(){}update(e){this.updateTraits(e)}}];class B{constructor(e){this.level=e,this.heartbeat=new O(this,3),this.init()}getEntity(e){return this.entities.get(e)}addEntity(e){let t=this.entityCount;return e.setId(t).setContainer(this),this.entities.set(t,e),this.entityCount++,t}removeEntity(e){this.removeFromBoard(e),this.entities.delete(e)}gainReward(e){let t=this.getEntity(e);t&&this.level.addCoin(t.reward.coin)}gainPunishment(e){this.level.playerDamaged(10)}gameCompleted(){this.level.gameCompleted()}addWave(e,t){let s=this.waves[e];s||(s=[]),s.push(t),this.waves[e]=s}get isOnboardEmpty(){return 0==this.onboard.size}releaseToBoard(e){this.onboard.add(e)}removeFromBoard(e){this.onboard.delete(e)}init(e){this.entityCount=0,this.entities=new Map,this.setWaves(e),this.onboard=new Set,this.accumulatedTime=0,this.releasingAccumulatedTime=0}setWaves(e){e&&(this.currWaveId=0,this.waves=[],e.waves.forEach(e=>{this.waves.push(e.slice())}))}appendRandomWave(){let e=Math.round(5*Math.random())+5,t=Array(e).fill(!0).map(e=>{return Math.floor(Math.random()*q.length)});this.waves.push(t)}onHeartbeat(){this.currWaveId>=this.waves.length&&this.appendRandomWave();let e=this.waves[this.currWaveId];if(e.length<=0)return void this.currWaveId++;let t=e.shift(),s=q[t](),i=Math.round(s.life.maxHp+s.life.maxHp*(this.currWaveId+1)/15);s.life.setHp(i),s.move.setPath(this.level.path);let n=this.addEntity(s);this.releaseToBoard(n)}update(e){this.heartbeat.update(e),this.onboard.forEach(t=>{let s=this.getEntity(t);s&&s.update(e)})}render(e,t){this.onboard.forEach(s=>{let i=this.getEntity(s);i&&i.render(e,t)})}}class _ extends C{constructor(e){super("equip"),this.entity=e,this.mounted=!1,this.equipment={damage:0,fireSpeed:0,range:0,weapon:""}}get isMounted(){return this.mounted}get damage(){return this.equipment.damage}get fireSpeed(){return this.equipment.fireSpeed}get range(){return this.equipment.range}get weapon(){return this.equipment.weapon}setEquipment(e){this.equipment=Object.assign(this.equipment,e),this.entity.heartbeat.beatTime=this.equipment.fireSpeed,this.mounted=!0}}class Y extends C{constructor(e){super("detectenemy"),this.entity=e,this.target=null}isInsideFireRange(e,t){return this.entity.equip.range>=g(e,t)}get onAimed(){return null!==this.target&&this.isAlive(this.target)}isAlive(e){return e.life.isAlive}faceTo(e){this.entity.face=m(this.entity.center,e.pos)}targetInRangeNearest(){let e=window.gameRef.level.entityMgr,t=e.onboard,s=this.entity.equip.range,i=s;t.forEach(t=>{let n=e.getEntity(t);if(this.isAlive(n)){let e=g(this.entity.center,n.pos);if(s>=e){let t=s-e;t<i&&(i=t,this.target=n)}}})}update(e){this.entity.equip.isMounted&&(null!==this.target&&this.faceTo(this.target),null!==this.target&&this.isInsideFireRange(this.entity.center,this.target.pos)&&this.isAlive(this.target)||(this.target=null,this.targetInRangeNearest()))}}class j extends C{constructor(e){super("bulletfly"),this.entity=e,this.speed=10}update(e){if(null!==this.entity.target){let t=this.entity.pos,s=this.entity.target.renderPos;if(g(t,s)<16)this.entity.hitPos=Object.assign({},s),setTimeout(()=>{this.entity.target.life.damage(this.entity.damage),this.entity.selfRemove()},1);else{let i=s.x>t.x?1:-1,n=s.y>t.y?1:-1,r=this.speed*e,a=r*i,o=r*n,h=Math.abs(s.x-t.x),l=Math.abs(s.y-t.y);h>=5&&(this.entity.pos.x+=a),l>=5&&(this.entity.pos.y+=o),this.entity.face=m(t,s)+90}}}}class X extends S{constructor(e=0,t=0,s=b.x,i=b.y){super(e,t,s,i),this.addTrait(new j(this)),this.tiles=[["299",0,0]],this.appendComponentTo(this,this.tiles),this.bulletfly.speed=100,this.target=null,this.hitPos=null}adjustStartPos(){this.pos.x+=.5*b.x,this.pos.y+=.5*b.y}setTarget(e){this.target=e,this.adjustStartPos()}setDamage(e){this.damage=e}update(e){this.updateTraits(e)}}class U extends C{constructor(e){super("weapon"),this.entity=e,this.bullets=new Map,this.bulletCount=0,this.gunShooting=!1}removeEntity(e){this.bullets.delete(e)}fire(e){e&&("rocket"==this.entity.equip.weapon?this.fireRocket(e):"single-gun"==this.entity.equip.weapon?this.fireGun(e):"double-gun"==this.entity.equip.weapon&&this.fireGun(e))}fireRocket(e){let t=this.bulletCount,s=new X(this.entity.pos.x,this.entity.pos.y);s.setId(t).setContainer(this),s.setTarget(e),s.setDamage(this.entity.equip.damage),this.bullets.set(t,s),this.bulletCount++}fireGun(e){this.gunShooting=!0,this.entity.fireSprite.show=!0,setTimeout(()=>{this.gunShooting=!1,this.entity.fireSprite.show=!1},1e3*this.entity.equip.fireSpeed),e.life.damage(this.entity.equip.damage)}update(e){this.bullets.forEach(t=>{t.update(e)})}render(e,t){switch(this.entity.equip.weapon){case"rocket":this.renderRocket(e,t);break;case"single-gun":case"double-gun":this.renderGun(e,t)}}renderGun(e,t){if(this.gunShooting&&this.entity.detectenemy.target){let s=this.entity.detectenemy.target.renderPos;t.render(e,"200",s.x,s.y),t.render(e,"200",s.x,s.y)}}renderRocket(e,t){this.bullets.forEach(s=>{null!==s.hitPos?(t.render(e,"201",s.hitPos.x,s.hitPos.y),t.render(e,"201",s.hitPos.x,s.hitPos.y),t.render(e,"201",s.hitPos.x,s.hitPos.y)):s.components.forEach(i=>{t.render(e,i.spriteName,s.renderPosX+i.offset.x,s.renderPosY+i.offset.y,s.face)})})}}class z extends S{constructor(e=0,t=0,s=b.x,i=b.y){super(e,t,s,i),this.addTrait(new O(this,1)),this.addTrait(new I(this)),this.addTrait(new _(this)),this.addTrait(new Y(this)),this.addTrait(new U(this)),this._face=270,this.fireSprite={spriteName:"",show:!1}}get renderPosX(){return this.pos.x}get renderPosY(){return this.pos.y}set face(e){this._face=e}get face(){return this._face+90}onClick(){window.gameRef.dashboard.towerMenu.isShow||(window.gameRef.dashboard.towerMenu.towerSelected(this),window.gameRef.dashboard.towerMenu.enable())}onHeartbeat(){this.equip.isMounted&&this.detectenemy.onAimed&&this.weapon.fire(this.detectenemy.target)}update(e){this.updateTraits(e)}render(e,t){this.traits.forEach(s=>{s.render(e,t)}),this.components.forEach(s=>{if(!1===s.attributes.show)return;let i=!1===s.attributes.rotatable?0:this.face;t.render(e,s.spriteName,this.renderPosX+s.offset.x,this.renderPosY+s.offset.y,i)}),!0===this.fireSprite.show&&t.render(e,this.fireSprite.spriteName,this.renderPosX,this.renderPosY,this.face)}}class ${constructor(e){this.level=e}init(e){this.towerCount=0,this.towers=new Map,e.forEach((e,t)=>{e.forEach((e,s)=>{if(null!==e){let e=this.towerCount,i=new z(t*b.x,s*b.y).setId(e);this.towers.set(e,i),this.towerCount++}})})}onMouseclick(e,t){this.towers.forEach(s=>{s.clickable.onClick(e,t)})}update(e){this.towers.forEach(t=>{t.update(e)})}render(e,t){this.towers.forEach(s=>{s.render(e,t)})}}class V{constructor(e){this.canvas=e,this.accumulatedTime=0,this.entityMgr=new B(this),this.towerMgr=new $(this),this.path=[{type:"begin",dest:new u(4.5*b.x,b.y)},{type:"line",dest:new u(4.5*b.x,3*b.y)},{type:"circle",orig:new u(5*b.x,3*b.y),dest:new u(5*b.x,3.5*b.y),cloc:!1,radi:2},{type:"circle",orig:new u(5*b.x,4*b.y),dest:new u(5.5*b.x,4*b.y),cloc:!0,radi:4},{type:"line",dest:new u(5.5*b.x,7*b.y)},{type:"circle",orig:new u(5*b.x,7*b.y),dest:new u(5*b.x,7.5*b.y),cloc:!0,radi:1},{type:"line",dest:new u(3*b.x,7.5*b.y)},{type:"circle",orig:new u(3*b.x,8*b.y),dest:new u(2.5*b.x,8*b.y),cloc:!1,radi:3},{type:"line",dest:new u(2.5*b.x,12*b.y)},{type:"circle",orig:new u(3*b.x,12*b.y),dest:new u(3*b.x,12.5*b.y),cloc:!1,radi:2},{type:"line",dest:new u(5*b.x,12.5*b.y)},{type:"circle",orig:new u(5*b.x,13*b.y),dest:new u(5.5*b.x,13*b.y),cloc:!0,radi:4},{type:"line",dest:new u(5.5*b.x,e.height+b.y/2)}]}init(e){this.gameState=e,this.accumulatedTime=0,this.entityMgr.init(this.waveSpec),this.towerMgr.init(this.towerMap);new u(144,2*b.y)}setWaveSpec(e){this.waveSpec=e}setTowerMap(e){this.towerMap=e}addCoin(e){this.gameState.coin+=e}playerDamaged(e){this.gameState.life-=e,this.gameState.life<0&&(this.gameState.life=0)}gameCompleted(){this.gameState.gameCompleted=!0}onMouseclick(e,t){this.towerMgr.onMouseclick(e,t)}update(e){this.accumulatedTime+=e,this.entityMgr.update(e),this.towerMgr.update(e)}render(e,t){this.entityMgr.render(e,t),this.towerMgr.render(e,t)}}class Q{constructor(){this.GAMEFLOW={IDLE:Symbol("idle"),WAITINGSTART:Symbol("waitingstart"),RUNNING:Symbol("running"),PAUSE:Symbol("pause"),GAMECOMPLETED:Symbol("gamecompleted"),GAMEOVER:Symbol("gameover")},this._currFlow=this.GAMEFLOW.IDLE}get currentFlow(){return this._currFlow}get isIdle(){return this._currFlow===this.GAMEFLOW.IDLE}get isWaitingStart(){return this._currFlow===this.GAMEFLOW.WAITINGSTART}get isRunning(){return this._currFlow===this.GAMEFLOW.RUNNING}get isPause(){return this._currFlow===this.GAMEFLOW.PAUSE}get isGameCompleted(){return this._currFlow===this.GAMEFLOW.GAMECOMPLETED}get isGameOver(){return this._currFlow===this.GAMEFLOW.GAMEOVER}idle(){this._currFlow=this.GAMEFLOW.IDLE}waitingStart(){this._currFlow=this.GAMEFLOW.WAITINGSTART}running(){this._currFlow=this.GAMEFLOW.RUNNING}pause(){this._currFlow=this.GAMEFLOW.PAUSE}gamecompleted(){this._currFlow=this.GAMEFLOW.GAMECOMPLETED}gameover(){this._currFlow=this.GAMEFLOW.GAMEOVER}}class J{constructor(e){this.sprites=e,this.containerDOM=n(document.getElementById("game")),this.btnBack=n(document.getElementById("btn-back-chatbot")),this.canvas=document.getElementById("canvas"),this.canvas.width=270,this.canvas.height=480,this.ctx=this.canvas.getContext("2d"),this.btnBack.addEventListener("click",e=>this.flyout()),this.board=new M,this.dashboard=new L(this.canvas),this.level=new V(this.canvas),this.gameFlow=new Q,window.gameRef=this,this.preload(),this.gameStateInit()}flyin(){this.containerDOM.show(),this.containerDOM.removeClass("flyout"),this.containerDOM.addClass("flyin"),setTimeout(()=>{this.gameFlow.isPause?this.gameFlow.running():this.gameFlow.isIdle?this.gameFlow.waitingStart():this.gameFlow.idle()},1e3)}flyout(){this.gameFlow.pause(),this.containerDOM.removeClass("flyin"),this.containerDOM.addClass("flyout"),setTimeout(()=>this.containerDOM.hide(),1e3)}createReceiveMousemoveFunc(){let e=this;return function(t,s){!e.gameFlow.isPause&&e.gameFlow.isIdle}}createReceiveMouseclickFunc(){let e=this;return function(t,s){return e.gameFlow.isWaitingStart||e.gameFlow.isGameOver||e.gameFlow.isGameCompleted?(e.gameInit(),void e.gameFlow.running()):e.gameFlow.isRunning?(e.dashboard.onMouseclick(t,s),void e.level.onMouseclick(t,s)):void(!e.gameFlow.isPause&&e.gameFlow.isIdle)}}preload(){Promise.all([v("public/json/towerDefense_tilesheet.json"),x("public/json/mobile-level-01.json"),x("public/json/waves.json")]).then(([e,t,s])=>{this.sprites=e,this.levelSpec=t,t.layers.forEach(e=>{this.board.addLayer(e.type,e.map),"tower"===e.type&&this.level.setTowerMap(e.map)}),this.level.setWaveSpec(s)})}gameStateInit(){this.gameState={score:0,coin:100,life:100,maxLife:100,gameCompleted:!1}}gameInit(){this.gameStateInit(),this.dashboard.init(this.gameState),this.level.init(this.gameState)}update(e){this.gameFlow.isPause||this.gameFlow.isIdle||(this.gameFlow.isRunning&&this.level.update(e),this.gameState.life<=0&&this.gameFlow.gameover(),!0===this.gameState.gameCompleted&&this.gameFlow.gamecompleted(),this.render(this.ctx))}render(e){switch(e.fillStyle="#000",e.fillRect(0,0,this.canvas.width,this.canvas.height),this.gameFlow.currentFlow){case this.gameFlow.GAMEFLOW.WAITINGSTART:this.renderWaitingStart(e);break;case this.gameFlow.GAMEFLOW.RUNNING:case this.gameFlow.GAMEFLOW.PAUSE:this.board.render(e,this.sprites),this.level.render(e,this.sprites),this.dashboard.render(e,this.sprites);break;case this.gameFlow.GAMEFLOW.GAMECOMPLETED:this.board.render(e,this.sprites),this.level.render(e,this.sprites),this.dashboard.render(e,this.sprites),this.renderGameCompleted(e);break;case this.gameFlow.GAMEFLOW.GAMEOVER:this.board.render(e,this.sprites),this.level.render(e,this.sprites),this.dashboard.render(e,this.sprites),this.renderGameOver(e)}}renderWaitingStart(e){this.renderText(e,"Click to start game","#fff","18px Arial")}renderGameCompleted(e){this.renderText(e,"Game Completed","#fff","30px Arial",-15),this.renderText(e,"Click to restart game","#fff","18px Arial",15)}renderGameOver(e){this.renderText(e,"Game Over","#fff","30px Arial",-15),this.renderText(e,"Click to restart game","#fff","18px Arial",15)}renderText(e,t,s,i,n=0){e.fillStyle=s,e.font=i;let r=e.measureText(t);e.fillText(t,(this.canvas.width-r.width)/2,(this.canvas.height-30)/2+n)}}!async function(){let e=document.querySelector("body"),t=document.getElementById("user-input"),s=document.getElementById("btn-user-input"),i=new d,n=new h,r=new J,a=new l(n,r),o=i.addTextInput(t,s);i.registerTextInputEvent(o,n.createReceiveMessageFunc()),i.registerTextInputEvent(o,a.createReceiveMessageFunc()),i.registerMouseEvent(e,"mousemove",r.createReceiveMousemoveFunc()),i.registerMouseEvent(e,"click",r.createReceiveMouseclickFunc()),i.initListener(),a.start();let u=new c;u.update=(e=>{r.update(e)}),u.start()}()}]);